- name: Create directory for manifests
  ansible.builtin.file:
    path: /etc/manifests
    owner: root
    group: sysadmin
    mode: '0751'
    state: directory
  become: true
  
- name: Create directory for docker-compose stacks
  ansible.builtin.file:
    path: /etc/manifests/docker-compose
    owner: root
    group: sysadmin
    mode: '0751'
    state: directory
  become: true

- name: Create directory for docker-compose system stacks
  ansible.builtin.file:
    path: /etc/manifests/docker-compose/system
    owner: root
    group: sysadmin
    mode: '0751'
    state: directory
  become: true

- name: Create directory for docker-compose calico stack
  ansible.builtin.file:
    path: /etc/manifests/docker-compose/system/calico
    owner: root
    group: sysadmin
    mode: '0751'
    state: directory
  become: true

- name: Install the calico docker-compose manifest
  ansible.builtin.copy:
    src: docker-compose/calico.yaml
    dest: /etc/manifests/docker-compose/system/calico/docker-compose.yaml
    owner: root
    group: sysadmin
    mode: '0640'
    remote_src: no
  become: true

- name: Create directory for docker-compose traefik stack
  ansible.builtin.file:
    path: /etc/manifests/docker-compose/system/traefik
    owner: root
    group: sysadmin
    mode: '0751'
    state: directory
  become: true

- name: Install the traefik docker-compose manifest
  ansible.builtin.copy:
    src: docker-compose/traefik.yaml
    dest: /etc/manifests/docker-compose/system/traefik/docker-compose.yaml
    owner: root
    group: sysadmin
    mode: '0640'
    remote_src: no
  become: true

- name: Deploy calico
  community.docker.docker_compose_v2:
    project_src: /etc/manifests/docker-compose/system/calico
    state: present
  become: true

- name: Deploy traefik
  community.docker.docker_compose_v2:
    project_src: /etc/manifests/docker-compose/system/traefik
    state: present
  become: true

- name: Check if kustomize is installed
  command: kustomize version
  register: kustomize_check
  ignore_errors: true
  changed_when: false

- name: Install kustomize
  shell: "curl -s 'https://raw.githubusercontent.com/kubernetes-sigs/kustomize/master/hack/install_kustomize.sh' | bash -s -- /usr/local/bin/"
  become: true
  when: kustomize_check.rc != 0

- name: Copy netpol HEP generator script
  copy:
    src: docker_netpol_heps.py
    dest: /usr/local/bin/docker_netpol_heps.py
    mode: '0755'
  become: true

- name: Configure Git credential storage
  command: "git config --global credential.helper store"

- name: Populate the Git credential store
  template:
    src: git_credentials.j2
    dest: /home/ansible/.git-credentials
    owner: ansible
    group: ansible
    mode: u=rw,g=,o=
  no_log: true